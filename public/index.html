<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Shift Notes & Inventory Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f7fafc;
            line-height: 1.6;
        }

        /* Login Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 28px;
        }

        .login-header p {
            color: #718096;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #4a5568;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4299e1;
        }

        .login-btn {
            width: 100%;
            background: #4299e1;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .login-btn:hover {
            background: #3182ce;
        }

        /* Main App Styles */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #2d3748;
            color: white;
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 30px 25px;
            border-bottom: 1px solid #4a5568;
        }

        .sidebar-header h2 {
            margin-bottom: 15px;
            font-size: 22px;
        }

        .user-info {
            font-size: 14px;
            color: #a0aec0;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            width: 100%;
            padding: 15px 25px;
            background: none;
            border: none;
            color: #e2e8f0;
            text-align: left;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: #4a5568;
            border-left-color: #4299e1;
        }

        .nav-item.active {
            background: #4a5568;
            border-left-color: #4299e1;
            color: #4299e1;
        }

        .nav-item.logout {
            margin-top: 20px;
            border-top: 1px solid #4a5568;
            color: #fc8181;
        }

        .main-content {
            margin-left: 280px;
            flex: 1;
            background: #f7fafc;
        }

        .page-header {
            background: white;
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header h1 {
            font-size: 28px;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .page-header p {
            color: #718096;
            font-size: 14px;
        }

        .page-content {
            padding: 30px;
        }

        /* Form Styles */
        .shift-note-form {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 200px 180px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-field {
            margin-bottom: 20px;
        }

        .form-field label {
            display: block;
            margin-bottom: 6px;
            color: #4a5568;
            font-weight: 500;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: #4299e1;
        }

        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Task Board Styles */
        .task-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .task-column {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        .column-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-title {
            font-weight: 600;
            color: #2d3748;
        }

        .task-count {
            background: #e2e8f0;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .task-list {
            padding: 15px;
        }

        .task-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: move;
            transition: all 0.3s;
        }

        .task-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .task-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .task-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .task-description {
            color: #718096;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .task-tickets {
            margin-bottom: 8px;
        }

        .ticket-link {
            background: #e2e8f0;
            color: #4a5568;
            padding: 3px 8px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 11px;
            margin-right: 5px;
            display: inline-block;
        }

        .ticket-link:hover {
            background: #cbd5e0;
        }

        .parts-used {
            margin-bottom: 8px;
        }

        .parts-badge {
            background: #fed7e2;
            color: #97266d;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 5px;
            display: inline-block;
        }

        .blocker-reason {
            background: #fed7d7;
            color: #c53030;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            margin-top: 8px;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        /* Add Task Form */
        .add-task-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .add-task-form {
            display: grid;
            gap: 20px;
        }

        /* Inventory Integration Styles */
        .inventory-integration {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .inventory-section h4 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 18px;
        }

        /* Inventory Search Styles */
        .inventory-search-container {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .search-result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f7fafc;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f7fafc;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .part-info {
            font-weight: 600;
            color: #2d3748;
        }

        .part-details {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }

        .stock-info {
            font-size: 11px;
            margin-top: 4px;
        }

        .stock-ok {
            color: #48bb78;
        }

        .stock-low {
            color: #ed8936;
            font-weight: 600;
        }

        .selected-inventory {
            margin-top: 10px;
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f7fafc;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }

        .inventory-item-info {
            flex: 1;
        }

        .inventory-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            text-align: center;
        }

        .remove-item {
            background: #fed7d7;
            color: #c53030;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-item:hover {
            background: #feb2b2;
        }

        /* Audits Section */
        .audits-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .audits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .audit-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .audit-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .audit-item label {
            cursor: pointer;
            color: #4a5568;
        }

        /* Inventory Page Styles */
        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .inventory-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-box {
            position: relative;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 12px 10px 40px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
        }

        .inventory-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .inventory-table thead {
            background: #f7fafc;
        }

        .inventory-table th,
        .inventory-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .inventory-table th {
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }

        .inventory-table tbody tr:hover {
            background: #f7fafc;
        }

        .editable {
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .editable:hover {
            background: #e2e8f0;
        }

        .editing input {
            width: 100%;
            padding: 6px;
            border: 2px solid #4299e1;
            border-radius: 4px;
            font-size: 14px;
        }

        .low-stock {
            color: #e53e3e;
            font-weight: 600;
        }

        /* Alert Styles */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        .alert-warning {
            background: #feebc8;
            color: #744210;
            border: 1px solid #f6d55c;
        }

        .alert-info {
            background: #ebf8ff;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }

        /* Error Messages */
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #feb2b2;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        /* Drop zone highlighting */
        .task-column.drag-over {
            background: #f7fafc;
            border: 2px dashed #4299e1;
        }

        /* Status indicators */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-active {
            background: #48bb78;
        }

        .status-blocked {
            background: #ed8936;
        }

        .status-completed {
            background: #9f7aea;
        }

        /* USER MANAGEMENT STYLES */
        .users-page {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .users-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
        }

        .users-header h3 {
            margin: 0;
            color: #1a202c;
            font-size: 24px;
            font-weight: 600;
        }

        #users-table-container {
            padding: 0;
            background: #ffffff;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .role-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role-admin {
            background: #fed7e2;
            color: #97266d;
        }

        .role-manager {
            background: #feebc8;
            color: #744210;
        }

        .role-technician {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-active {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-inactive {
            background: #fed7d7;
            color: #742a2a;
        }

        /* MODAL STYLES - FULL VIEWPORT FIX */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
            margin: 0 !important;
            margin-left: 0 !important;
        }

        .modal-content {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 500px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            position: relative;
            margin: 0 auto;
            z-index: 10001;
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: #1a202c !important;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #718096 !important;
            cursor: pointer;
            padding: 5px;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .modal-close:hover {
            background: #e2e8f0;
            color: #2d3748 !important;
        }

        .modal-form {
            padding: 30px;
            background: #ffffff;
        }

        .modal-form .form-field {
            margin-bottom: 20px;
        }

        .modal-form .form-field:last-of-type {
            margin-bottom: 0;
        }

        .modal-form label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748 !important;
            font-weight: 500;
            font-size: 14px;
        }

        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: #ffffff !important;
            color: #2d3748 !important;
            box-sizing: border-box;
        }

        .modal-form input:focus,
        .modal-form select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .modal-form input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            margin-bottom: 0;
            vertical-align: middle;
            background: #ffffff !important;
        }

        .modal-form label:has(input[type="checkbox"]) {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            cursor: pointer;
            color: #2d3748 !important;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid #e2e8f0;
        }

        .modal-actions .btn {
            min-width: 100px;
            padding: 12px 20px;
            font-weight: 600;
        }

        .modal-overlay,
        .modal-overlay * {
            color: #2d3748 !important;
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea,
        .modal-content button {
            color: #2d3748 !important;
            background: #ffffff !important;
        }

        .modal-content .btn-primary {
            background: #4299e1 !important;
            color: #ffffff !important;
        }

        .modal-content .btn-secondary {
            background: #718096 !important;
            color: #ffffff !important;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }

            .main-content {
                margin-left: 0;
            }

            .task-board {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .add-task-form {
                grid-template-columns: 1fr;
            }

            .page-content {
                padding: 15px;
            }

            .page-header {
                padding: 15px 20px;
                flex-direction: column;
                align-items: flex-start;
            }

            .modal-overlay {
                padding: 10px;
            }
            
            .modal-content {
                max-width: none;
                max-height: calc(100vh - 20px);
            }
            
            .modal-header {
                padding: 20px;
            }
            
            .modal-form {
                padding: 20px;
            }
            
            .modal-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-actions .btn {
                width: 100%;
                min-width: auto;
            }

            .user-actions {
                flex-direction: column;
            }
            
            .user-actions .btn {
                font-size: 11px;
                padding: 4px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>üîß IT System</h1>
                <p>Integrated Shift Notes & Inventory Management</p>
            </div>
            
            <div id="login-error" class="error-message hidden"></div>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="login-btn">
                    <span id="login-text">Sign In</span>
                    <span id="login-loading" class="hidden">Signing In...</span>
                </button>
            </form>
            
            <div style="margin-top: 20px; text-align: center; font-size: 12px; color: #718096;">
                Demo: admin@company.com / admin123, john@company.com / password123
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container" class="app-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>IT System</h2>
                <div class="user-info">
                    <div id="user-name">Loading...</div>
                    <div id="user-role">Loading...</div>
                </div>
            </div>
            
            <nav class="nav-menu">
                <button class="nav-item active" data-page="shift-notes">üìù My Shift</button>
                <button class="nav-item" data-page="recent-notes">üìã Recent Notes</button>
                <button class="nav-item" data-page="search-notes">üîç Search Notes</button>
                <button class="nav-item" data-page="inventory">üì¶ Inventory</button>
                <button class="nav-item" data-page="reports">üìà Reports</button>
                <button class="nav-item" data-page="users" id="users-nav" style="display: none;">üë• Users</button>
                <button class="nav-item logout" onclick="logout()">üö™ Logout</button>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <div>
                    <h1 id="page-title">My Shift</h1>
                    <p id="page-subtitle">Integrated shift documentation and inventory management</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="generateShiftSummary()">üìÑ Generate Summary</button>
                    <button class="btn btn-secondary" onclick="saveShiftNote()">üíæ Save Shift</button>
                </div>
            </div>
            
            <div class="page-content" id="page-content">
                <!-- Shift Notes Content -->
                <div id="shift-notes-content">
                    <!-- Shift Note Form -->
                    <div class="shift-note-section">
                        <h3 style="margin-bottom: 20px;">üìù Shift Documentation</h3>
                        <form id="shift-note-form" class="shift-note-form">
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="shift-title">Shift Title *</label>
                                    <input type="text" id="shift-title" required>
                                </div>
                                <div class="form-field">
                                    <label for="shift-type">Shift Type</label>
                                    <select id="shift-type">
                                        <option value="day">Day Shift</option>
                                        <option value="evening">Evening Shift</option>
                                        <option value="night">Night Shift</option>
                                        <option value="weekend">Weekend Shift</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label for="shift-date">Date</label>
                                    <input type="date" id="shift-date">
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="shift-content">Shift Notes & Summary</label>
                                <textarea id="shift-content" rows="6" placeholder="Enter your shift notes, observations, completed work, issues encountered, etc..."></textarea>
                            </div>
                        </form>
                    </div>

                    <!-- Inventory Quick Access -->
                    <div class="inventory-integration">
                        <div class="inventory-section">
                            <h4>üì¶ Inventory Quick Access</h4>
                            <div class="search-box">
                                <input type="text" id="inventory-quick-search" placeholder="Search parts by number, name, or vendor...">
                            </div>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary btn-sm" onclick="navigateTo('inventory')">+ Add New Item</button>
                                <button class="btn btn-secondary btn-sm" onclick="navigateTo('inventory')" style="margin-left: 10px;">Bulk Update</button>
                            </div>
                        </div>
                    </div>

                    <!-- Add New Task -->
                    <div class="add-task-section">
                        <h3 style="margin-bottom: 20px;">‚ûï Add New Task</h3>
                        <form id="add-task-form" class="add-task-form">
                            <div class="form-field">
                                <label for="task-title">Task Title *</label>
                                <input type="text" id="task-title" placeholder="e.g., Antenna installation for Building A" required>
                            </div>
                            
                            <div class="form-field">
                                <label for="task-description">Description</label>
                                <textarea id="task-description" placeholder="Additional details..." rows="3"></textarea>
                            </div>
                            
                            <div class="form-field">
                                <label for="task-tickets">Tickets (comma separated)</label>
                                <input type="text" id="task-tickets" placeholder="RITM8042334, QB-12345">
                            </div>
                            
                            <!-- Inventory Section -->
                            <div class="form-field">
                                <label for="inventory-search">Inventory Used</label>
                                <div class="inventory-search-container">
                                    <input type="text" id="inventory-search" placeholder="Search for parts, materials, or equipment..." autocomplete="off">
                                    <div id="inventory-search-results" class="search-results hidden"></div>
                                </div>
                                <div id="selected-inventory" class="selected-inventory"></div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Add Task</button>
                        </form>
                    </div>

                    <!-- Task Board -->
                    <div class="task-board">
                        <div class="task-column" data-status="active">
                            <div class="column-header">
                                <span class="column-title">üü¢ Active Tasks</span>
                                <span class="task-count" id="active-count">0</span>
                            </div>
                            <div class="task-list" id="active-tasks"></div>
                        </div>
                        
                        <div class="task-column" data-status="blocked">
                            <div class="column-header">
                                <span class="column-title">üü° Blocked Tasks</span>
                                <span class="task-count" id="blocked-count">0</span>
                            </div>
                            <div class="task-list" id="blocked-tasks"></div>
                        </div>
                        
                        <div class="task-column" data-status="completed">
                            <div class="column-header">
                                <span class="column-title">üü£ Completed Tasks</span>
                                <span class="task-count" id="completed-count">0</span>
                            </div>
                            <div class="task-list" id="completed-tasks"></div>
                        </div>
                    </div>

                    <!-- Daily Audits -->
                    <div class="audits-section">
                        <h3 style="margin-bottom: 20px;">‚úÖ Daily Audits</h3>
                        <form id="audits-form">
                            <div class="audits-grid">
                                <div class="audit-item">
                                    <input type="checkbox" id="tel-lane" name="tel_lane">
                                    <label for="tel-lane">TEL Lane Check</label>
                                </div>
                                <div class="audit-item">
                                    <input type="checkbox" id="gate-lane" name="gate_lane">
                                    <label for="gate-lane">Gate Lane Check</label>
                                </div>
                                <div class="audit-item">
                                    <input type="checkbox" id="tel-simulation" name="tel_simulation">
                                    <label for="tel-simulation">TEL Simulation</label>
                                </div>
                                <div class="audit-item">
                                    <input type="checkbox" id="quickbase-dashboard" name="quickbase_dashboard">
                                    <label for="quickbase-dashboard">QuickBase Dashboard</label>
                                </div>
                                <div class="audit-item">
                                    <input type="checkbox" id="mechanics-availability" name="mechanics_availability">
                                    <label for="mechanics-availability">Mechanics Availability</label>
                                </div>
                            </div>
                            <button type="button" class="btn btn-success mt-20" onclick="updateAudits()">Update Audits</button>
                        </form>
                    </div>
                </div>

                <!-- Recent Notes Content -->
                <div id="recent-notes-content" class="hidden">
                    <div class="inventory-reports">
                        <h3 style="margin-bottom: 20px;">üìã Recent Shift Notes - All Employees</h3>
                        
                        <div class="report-filters">
                            <div class="form-field">
                                <label for="notes-days">Show Last</label>
                                <select id="notes-days">
                                    <option value="7">7 Days</option>
                                    <option value="14">14 Days</option>
                                    <option value="30">30 Days</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label for="notes-employee">Employee</label>
                                <select id="notes-employee">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="loadRecentNotes()">Load Notes</button>
                        </div>
                        
                        <div id="recent-notes-results" class="notes-results">
                            <div class="loading">Select filters and click "Load Notes" to view recent shift notes.</div>
                        </div>
                    </div>
                </div>

                <!-- Search Notes Content -->
                <div id="search-notes-content" class="hidden">
                    <div class="search-section">
                        <h3 style="margin-bottom: 20px;">üîç Search Shift Notes & Tasks</h3>
                        
                        <div class="search-form">
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="search-query">Search Query</label>
                                    <input type="text" id="search-query" placeholder="Enter keywords, task names, or ticket numbers...">
                                </div>
                                <div class="form-field">
                                    <label for="search-employee">Employee</label>
                                    <select id="search-employee">
                                        <option value="">All Employees</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label for="search-start-date">Start Date</label>
                                    <input type="date" id="search-start-date">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="search-end-date">End Date</label>
                                    <input type="date" id="search-end-date">
                                </div>
                                <div class="form-field" style="display: flex; align-items: end;">
                                    <button class="btn btn-primary" onclick="searchNotes()">Search Notes</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="search-results" class="notes-results">
                            <div class="loading">Enter search criteria and click "Search Notes" to find relevant shift notes.</div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Content -->
                <div id="inventory-content" class="hidden">
                    <div class="inventory-page">
                        <div class="inventory-header">
                            <h3>üì¶ Inventory Management</h3>
                            <div class="inventory-controls">
                                <div class="search-box">
                                    <input type="text" id="inv-search" placeholder="Search inventory...">
                                </div>
                                <label>
                                    <input type="checkbox" id="show-low-stock"> Show Low Stock Only
                                </label>
                                <button class="btn btn-primary" onclick="addNewInventoryItem()">+ Add New Item</button>
                            </div>
                        </div>
                        
                        <div id="inventory-results">
                            <table class="inventory-table">
                                <thead>
                                    <tr>
                                        <th>Part Number</th>
                                        <th>Vendor</th>
                                        <th>Product</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Location</th>
                                        <th>Min Qty</th>
                                        <th>Current Qty / Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table-body">
                                    <tr>
                                        <td colspan="8" class="loading">Loading inventory...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reports Content -->
                <div id="reports-content" class="hidden">
                    <div class="reports-page">
                        <h3 style="margin-bottom: 20px;">üìà Reports & Analytics</h3>
                        
                        <div class="report-sections">
                            <div class="report-section">
                                <h4>Inventory Reports</h4>
                                <button class="btn btn-secondary" onclick="generateInventoryReport('usage')">Usage Report</button>
                                <button class="btn btn-secondary" onclick="generateInventoryReport('low_stock')">Low Stock Report</button>
                                <button class="btn btn-secondary" onclick="generateInventoryReport('transactions')">Transaction History</button>
                            </div>
                        </div>
                        
                        <div id="report-results"></div>
                    </div>
                </div>

                <!-- Users Content -->
                <div id="users-content" class="hidden">
                    <div class="users-page">
                        <div class="users-header">
                            <h3>üë• User Management</h3>
                            <button class="btn btn-primary" onclick="showAddUserModal()">+ Add New User</button>
                        </div>
                        
                        <div id="users-table-container">
                            <div class="loading">Loading users...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let currentShift = null;
        let allTasks = [];
        let allUsers = [];
        let currentPage = 'shift-notes';
        let draggedTask = null;
        let inventoryData = [];
        let searchTimeout;
        let selectedInventoryItems = [];
        let editingUserId = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing IT Shift Notes & Inventory System...');
            
            initializeEventListeners();
            
            if (authToken) {
                validateTokenAndShowApp();
            } else {
                showLogin();
            }
        });

        function initializeEventListeners() {
            // Login form
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            // Navigation
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', function() {
                    navigateTo(this.dataset.page);
                });
            });
            
            // Add task form
            const addTaskForm = document.getElementById('add-task-form');
            if (addTaskForm) {
                addTaskForm.addEventListener('submit', handleAddTask);
            }

            // Initialize inventory search for task creation
            initializeInventorySearch();
            
            // Page-specific inventory search
            const invSearch = document.getElementById('inv-search');
            if (invSearch) {
                invSearch.addEventListener('input', debounce(searchInventoryPage, 300));
            }
            
            const showLowStock = document.getElementById('show-low-stock');
            if (showLowStock) {
                showLowStock.addEventListener('change', searchInventoryPage);
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.inventory-search-container')) {
                    const dropdown = document.getElementById('inventory-search-results');
                    if (dropdown) {
                        dropdown.classList.add('hidden');
                    }
                }
            });
        }

        // Inventory search functionality
        function initializeInventorySearch() {
            const searchInput = document.getElementById('inventory-search');
            const resultsContainer = document.getElementById('inventory-search-results');
            
            if (!searchInput) return;
            
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    resultsContainer.classList.add('hidden');
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    searchInventory(query);
                }, 300);
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                    resultsContainer.classList.add('hidden');
                }
            });
        }

        async function searchInventory(query) {
            try {
                const response = await fetch(`/api/inventory/search?q=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Search failed');
                
                const items = await response.json();
                displaySearchResults(items);
                
            } catch (error) {
                console.error('Inventory search error:', error);
            }
        }

        function displaySearchResults(items) {
            const resultsContainer = document.getElementById('inventory-search-results');
            
            if (items.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No items found</div>';
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            resultsContainer.innerHTML = items.map(item => `
                <div class="search-result-item" onclick="selectInventoryItem(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <div class="part-info">${item.part_number}</div>
                    <div class="part-details">${item.vendor} - ${item.product}</div>
                    <div class="stock-info ${item.low_stock ? 'stock-low' : 'stock-ok'}">
                        Stock: ${item.quantity} ${item.low_stock ? '(Low Stock!)' : ''}
                    </div>
                </div>
            `).join('');
            
            resultsContainer.classList.remove('hidden');
        }

        function selectInventoryItem(item) {
            // Check if item already selected
            if (selectedInventoryItems.find(i => i.id === item.id)) {
                showAlert('warning', 'Item already selected');
                return;
            }
            
            selectedInventoryItems.push({
                ...item,
                quantity_used: 1
            });
            
            updateSelectedInventoryDisplay();
            
            // Clear search
            document.getElementById('inventory-search').value = '';
            document.getElementById('inventory-search-results').classList.add('hidden');
        }

        function updateSelectedInventoryDisplay() {
            const container = document.getElementById('selected-inventory');
            
            if (selectedInventoryItems.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = selectedInventoryItems.map((item, index) => `
                <div class="inventory-item">
                    <div class="inventory-item-info">
                        <strong>${item.part_number}</strong><br>
                        <small>${item.vendor} - ${item.product}</small>
                        ${item.low_stock ? '<br><span class="stock-low">‚ö†Ô∏è Low Stock</span>' : ''}
                    </div>
                    <div class="inventory-item-controls">
                        <label>Qty:</label>
                        <input type="number" min="1" max="${item.quantity}" value="${item.quantity_used}" 
                               class="quantity-input" onchange="updateQuantity(${index}, this.value)">
                        <button type="button" class="remove-item" onclick="removeInventoryItem(${index})">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function updateQuantity(index, newQuantity) {
            const item = selectedInventoryItems[index];
            const qty = parseInt(newQuantity);
            
            if (qty > item.quantity) {
                showAlert('error', `Only ${item.quantity} available in stock`);
                updateSelectedInventoryDisplay();
                return;
            }
            
            selectedInventoryItems[index].quantity_used = qty;
        }

        function removeInventoryItem(index) {
            selectedInventoryItems.splice(index, 1);
            updateSelectedInventoryDisplay();
        }

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            console.log('üîê Attempting login...');
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            const loginText = document.getElementById('login-text');
            const loginLoading = document.getElementById('login-loading');
            
            // Show loading state
            loginText.classList.add('hidden');
            loginLoading.classList.remove('hidden');
            loginError.classList.add('hidden');
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Login failed');
                }
                
                authToken = data.token;
                currentUser = data.user;
                localStorage.setItem('authToken', authToken);
                
                console.log('‚úÖ Login successful!');
                showApp();
                
            } catch (error) {
                console.error('‚ùå Login error:', error);
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            } finally {
                loginText.classList.remove('hidden');
                loginLoading.classList.add('hidden');
            }
        }

        function validateTokenAndShowApp() {
            try {
                const tokenParts = authToken.split('.');
                if (tokenParts.length === 3) {
                    const payload = JSON.parse(atob(tokenParts[1]));
                    currentUser = {
                        id: payload.id,
                        email: payload.email,
                        role: payload.role,
                        name: payload.email.split('@')[0]
                    };
                    
                    console.log('‚úÖ Token valid, showing app...');
                    showApp();
                } else {
                    throw new Error('Invalid token');
                }
            } catch (error) {
                console.error('‚ùå Token validation failed:', error);
                localStorage.removeItem('authToken');
                authToken = null;
                showLogin();
            }
        }

        function logout() {
            console.log('üö™ Logging out...');
            localStorage.removeItem('authToken');
            authToken = null;
            currentUser = null;
            showLogin();
        }

        function showLogin() {
            console.log('üîê Showing login page...');
            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            
            if (loginPage) loginPage.classList.remove('hidden');
            if (appContainer) appContainer.classList.add('hidden');
        }

        function showApp() {
            console.log('üì± Showing app...');
            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            
            if (loginPage) loginPage.classList.add('hidden');
            if (appContainer) appContainer.classList.remove('hidden');
            
            if (currentUser) {
                const userName = currentUser.name || currentUser.email.split('@')[0];
                const userRole = currentUser.role || 'user';
                
                const userNameEl = document.getElementById('user-name');
                const userRoleEl = document.getElementById('user-role');
                
                if (userNameEl) userNameEl.textContent = userName;
                if (userRoleEl) userRoleEl.textContent = userRole.toUpperCase();
                
                const usersNav = document.getElementById('users-nav');
                if (usersNav && ['admin', 'manager'].includes(userRole)) {
                    usersNav.style.display = 'block';
                }
            }
            
            // Load default page
            navigateTo('shift-notes');
        }

        // Navigation functions
        function navigateTo(page) {
            console.log('üß≠ Navigating to:', page);
            currentPage = page;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNavItem = document.querySelector(`.nav-item[data-page="${page}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }
            
            // Hide all content sections
            const shiftNotesContent = document.getElementById('shift-notes-content');
            const recentNotesContent = document.getElementById('recent-notes-content');
            const searchNotesContent = document.getElementById('search-notes-content');
            const inventoryContent = document.getElementById('inventory-content');
            const reportsContent = document.getElementById('reports-content');
            const usersContent = document.getElementById('users-content');
            
            if (shiftNotesContent) shiftNotesContent.classList.add('hidden');
            if (recentNotesContent) recentNotesContent.classList.add('hidden');
            if (searchNotesContent) searchNotesContent.classList.add('hidden');
            if (inventoryContent) inventoryContent.classList.add('hidden');
            if (reportsContent) reportsContent.classList.add('hidden');
            if (usersContent) usersContent.classList.add('hidden');
            
            switch(page) {
                case 'shift-notes':
                    updatePageHeader('My Shift', 'Integrated shift documentation and inventory management');
                    if (shiftNotesContent) {
                        shiftNotesContent.classList.remove('hidden');
                        loadCurrentShift();
                    }
                    break;
                case 'recent-notes':
                    updatePageHeader('Recent Notes', 'View recent shift notes from all employees');
                    if (recentNotesContent) {
                        recentNotesContent.classList.remove('hidden');
                        loadRecentNotesPage();
                    }
                    break;
                case 'search-notes':
                    updatePageHeader('Search Notes', 'Search and filter shift notes and tasks');
                    if (searchNotesContent) {
                        searchNotesContent.classList.remove('hidden');
                        loadSearchNotesPage();
                    }
                    break;
                case 'inventory':
                    updatePageHeader('Inventory', 'Manage parts and supplies');
                    if (inventoryContent) {
                        inventoryContent.classList.remove('hidden');
                        loadInventoryPage();
                    }
                    break;
                case 'reports':
                    updatePageHeader('Reports', 'Analytics and inventory reports');
                    if (reportsContent) {
                        reportsContent.classList.remove('hidden');
                        loadReportsPage();
                    }
                    break;
                case 'users':
                    updatePageHeader('User Management', 'Manage system users and permissions');
                    if (usersContent) {
                        usersContent.classList.remove('hidden');
                        loadUsersPage();
                    }
                    break;
            }
        }

        function updatePageHeader(title, subtitle) {
            const titleEl = document.getElementById('page-title');
            const subtitleEl = document.getElementById('page-subtitle');
            
            if (titleEl) titleEl.textContent = title;
            if (subtitleEl) subtitleEl.textContent = subtitle;
        }

        // Shift Management Functions
        async function loadCurrentShift() {
            console.log('üìã Loading current shift...');
            
            try {
                showLoading('Loading your shift...');
                
                const response = await fetch('/api/shifts/current', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                console.log('üì° Current shift response:', response.status);
                
                if (!response.ok) throw new Error('Failed to load shift');
                
                const data = await response.json();
                console.log('üìã Shift data:', data);
                
                currentShift = data;
                allTasks = data.tasks || [];
                
                // Populate shift form
                populateShiftForm(data.shift);
                
                hideLoading();
                
                // Render audits and tasks
                renderAudits(data.audits);
                renderTasks();
                
                console.log('‚úÖ Current shift loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Load current shift error:', error);
                hideLoading();
                showAlert('error', 'Error loading shift: ' + error.message);
            }
        }

        function populateShiftForm(shift) {
            if (!shift) return;
            
            const titleEl = document.getElementById('shift-title');
            const typeEl = document.getElementById('shift-type');
            const dateEl = document.getElementById('shift-date');
            const contentEl = document.getElementById('shift-content');
            
            if (titleEl) titleEl.value = shift.title || '';
            if (typeEl) typeEl.value = shift.shift_type || 'day';
            if (contentEl) contentEl.value = shift.content || '';
            
            // Proper date formatting for HTML date input
            if (dateEl && shift.shift_date) {
                const date = new Date(shift.shift_date);
                const formattedDate = date.toISOString().split('T')[0];
                dateEl.value = formattedDate;
            }
        }

        async function saveShiftNote() {
            console.log('üíæ Saving shift note...');
            
            if (!currentShift || !currentShift.shift_id) {
                showAlert('error', 'No active shift found');
                return;
            }
            
            const title = document.getElementById('shift-title').value;
            const shiftType = document.getElementById('shift-type').value;
            const content = document.getElementById('shift-content').value;
            
            if (!title.trim()) {
                showAlert('error', 'Shift title is required');
                return;
            }
            
            try {
                const response = await fetch(`/api/shifts/${currentShift.shift_id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        shift_type: shiftType
                    })
                });
                
                if (!response.ok) throw new Error('Failed to save shift');
                
                showAlert('success', 'Shift notes saved successfully');
                
            } catch (error) {
                console.error('‚ùå Save shift error:', error);
                showAlert('error', 'Error saving shift: ' + error.message);
            }
        }

        // Task Management Functions
        function renderTasks() {
            console.log('üéØ Rendering tasks...');
            
            const activeTasks = document.getElementById('active-tasks');
            const blockedTasks = document.getElementById('blocked-tasks');
            const completedTasks = document.getElementById('completed-tasks');
            
            // Clear existing tasks
            if (activeTasks) activeTasks.innerHTML = '';
            if (blockedTasks) blockedTasks.innerHTML = '';
            if (completedTasks) completedTasks.innerHTML = '';
            
            // Group tasks by status
            const tasksByStatus = {
                active: allTasks.filter(t => t.status === 'active'),
                blocked: allTasks.filter(t => t.status === 'blocked'),
                completed: allTasks.filter(t => t.status === 'completed')
            };
            
            console.log('üìä Tasks by status:', tasksByStatus);
            
            // Render each group
            Object.keys(tasksByStatus).forEach(status => {
                const container = document.getElementById(status + '-tasks');
                const tasks = tasksByStatus[status];
                
                if (container) {
                    tasks.forEach(task => {
                        const taskElement = createTaskElement(task);
                        container.appendChild(taskElement);
                    });
                }
            });
            
            // Update counts
            const activeCount = document.getElementById('active-count');
            const blockedCount = document.getElementById('blocked-count');
            const completedCount = document.getElementById('completed-count');
            
            if (activeCount) activeCount.textContent = tasksByStatus.active.length;
            if (blockedCount) blockedCount.textContent = tasksByStatus.blocked.length;
            if (completedCount) completedCount.textContent = tasksByStatus.completed.length;
        }

        function createTaskElement(task) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-card';
            taskDiv.draggable = true;
            taskDiv.dataset.taskId = task.id;
            
            taskDiv.addEventListener('dragstart', function(e) {
                draggedTask = task;
                this.classList.add('dragging');
            });
            
            taskDiv.addEventListener('dragend', function(e) {
                this.classList.remove('dragging');
            });
            
            let ticketsHtml = '';
            if (task.tickets && task.tickets.length > 0) {
                const tickets = JSON.parse(task.tickets);
                ticketsHtml = '<div class="task-tickets">' + 
                    tickets.map(ticket => `<a href="${formatTicketLink(ticket)}" class="ticket-link" target="_blank">${ticket}</a>`).join('') + 
                    '</div>';
            }
            
            let partsHtml = '';
            if (task.parts_used && task.parts_used.length > 0) {
                const parts = JSON.parse(task.parts_used);
                partsHtml = '<div class="parts-used">' + 
                    parts.map(part => `<span class="parts-badge">${part.part_number} (${part.quantity})</span>`).join('') + 
                    '</div>';
            }
            
            let blockerHtml = '';
            if (task.status === 'blocked' && task.blocker_reason) {
                blockerHtml = `<div class="blocker-reason">${task.blocker_reason}</div>`;
            }
            
            taskDiv.innerHTML = `
                <div class="task-title">
                    <span class="status-indicator status-${task.status}"></span>
                    ${task.title}
                </div>
                ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                ${ticketsHtml}
                ${partsHtml}
                ${blockerHtml}
                <div class="task-actions">
                    ${task.status !== 'completed' ? `<button class="btn btn-success btn-sm" onclick="updateTaskStatus(${task.id}, 'completed')">Complete</button>` : ''}
                    ${task.status !== 'blocked' ? `<button class="btn btn-danger btn-sm" onclick="updateTaskStatus(${task.id}, 'blocked')">Block</button>` : ''}
                    ${task.status !== 'active' ? `<button class="btn btn-primary btn-sm" onclick="updateTaskStatus(${task.id}, 'active')">Activate</button>` : ''}
                </div>
            `;
            
            return taskDiv;
        }

        function formatTicketLink(ticket) {
            if (ticket.startsWith('RITM') || ticket.startsWith('INC') || ticket.startsWith('CHG')) {
                return `https://your-servicenow-instance.service-now.com/nav_to.do?uri=${ticket}`;
            } else if (ticket.startsWith('QB-')) {
                return `https://your-quickbase-instance.quickbase.com/db/xyz?a=dr&rid=${ticket.replace('QB-', '')}`;
            }
            return '#';
        }

        async function updateTaskStatus(taskId, newStatus) {
            console.log(`üîÑ Updating task ${taskId} to ${newStatus}...`);
            
            try {
                let blocker_reason = null;
                
                if (newStatus === 'blocked') {
                    const options = [
                        'Waiting for parts/equipment',
                        'Waiting for approval/authorization',
                        'Technical issue encountered',
                        'External dependency',
                        'Resource unavailable',
                        'Safety concern'
                    ];
                    
                    const choice = prompt('Why is this task blocked?\n\n' + 
                        options.map((opt, i) => `${i + 1}. ${opt}`).join('\n') + 
                        '\n\nOr enter custom reason:');
                    
                    if (choice && !isNaN(choice) && choice >= 1 && choice <= options.length) {
                        blocker_reason = options[choice - 1];
                    } else if (choice) {
                        blocker_reason = choice;
                    } else {
                        return;
                    }
                }
                
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ 
                        status: newStatus,
                        blocker_reason: blocker_reason
                    })
                });
                
                if (!response.ok) throw new Error('Failed to update task');
                
                // Update local task data
                const task = allTasks.find(t => t.id == taskId);
                if (task) {
                    task.status = newStatus;
                    task.blocker_reason = blocker_reason;
                }
                
                renderTasks();
                showAlert('success', 'Task status updated successfully');
                
            } catch (error) {
                console.error('‚ùå Update task error:', error);
                showAlert('error', 'Error updating task: ' + error.message);
                renderTasks();
            }
        }

        // Add Task Functions
        async function handleAddTask(e) {
            e.preventDefault();
            console.log('‚ûï Adding new task...');
            
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const ticketsText = document.getElementById('task-tickets').value;
            
            if (!title.trim()) {
                showAlert('error', 'Task title is required');
                return;
            }
            
            if (!currentShift || !currentShift.shift_id) {
                showAlert('error', 'No active shift found');
                return;
            }
            
            const tickets = ticketsText.split(',').map(t => t.trim()).filter(t => t);
            
            // Prepare parts used data
            const parts_used = selectedInventoryItems.map(item => ({
                part_number: item.part_number,
                quantity: item.quantity_used,
                id: item.id
            }));
            
            try {
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        shift_id: currentShift.shift_id,
                        title: title,
                        description: description,
                        tickets: tickets,
                        parts_used: parts_used,
                        status: 'active'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to add task');
                }
                
                const data = await response.json();
                
                // Add to local tasks array
                const newTask = {
                    id: data.id,
                    title: title,
                    description: description,
                    status: 'active',
                    tickets: JSON.stringify(tickets),
                    parts_used: JSON.stringify(parts_used),
                    created_at: new Date().toISOString(),
                    blocker_reason: null
                };
                
                allTasks.push(newTask);
                
                // Clear form and selected items
                const addTaskForm = document.getElementById('add-task-form');
                if (addTaskForm) addTaskForm.reset();
                selectedInventoryItems = [];
                updateSelectedInventoryDisplay();
                
                renderTasks();
                showAlert('success', 'Task added successfully');
                
                // Reload current shift to get updated inventory
                loadCurrentShift();
                
            } catch (error) {
                console.error('‚ùå Add task error:', error);
                showAlert('error', 'Error adding task: ' + error.message);
            }
        }

        // Audit Functions
        async function updateAudits() {
            console.log('‚úÖ Updating audits...');
            
            if (!currentShift) {
                console.warn('‚ö†Ô∏è No current shift found');
                return;
            }
            
            const formData = {
                shift_id: currentShift.shift_id,
                tel_lane: document.getElementById('tel-lane').checked,
                gate_lane: document.getElementById('gate-lane').checked,
                tel_simulation: document.getElementById('tel-simulation').checked,
                quickbase_dashboard: document.getElementById('quickbase-dashboard').checked,
                mechanics_availability: document.getElementById('mechanics-availability').checked
            };
            
            try {
                const response = await fetch('/api/audits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Failed to update audits');
                
                showAlert('success', 'Audits updated successfully');
                
            } catch (error) {
                console.error('‚ùå Update audits error:', error);
                showAlert('error', 'Error updating audits: ' + error.message);
            }
        }

        function renderAudits(audits) {
            if (!audits) return;
            
            document.getElementById('tel-lane').checked = audits.tel_lane || false;
            document.getElementById('gate-lane').checked = audits.gate_lane || false;
            document.getElementById('tel-simulation').checked = audits.tel_simulation || false;
            document.getElementById('quickbase-dashboard').checked = audits.quickbase_dashboard || false;
            document.getElementById('mechanics-availability').checked = audits.mechanics_availability || false;
        }

        // Inventory Management Functions
        async function loadInventoryPage() {
            console.log('üì¶ Loading inventory page...');
            searchInventoryPage();
        }

        async function searchInventoryPage() {
            const search = document.getElementById('inv-search').value;
            const lowStockOnly = document.getElementById('show-low-stock').checked;
            
            try {
                let url = '/api/inventory?limit=100';
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (lowStockOnly) url += '&low_stock=true';
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load inventory');
                
                const data = await response.json();
                displayInventoryTable(data.items);
                
            } catch (error) {
                console.error('‚ùå Load inventory error:', error);
                showAlert('error', 'Error loading inventory: ' + error.message);
            }
        }

        function displayInventoryTable(items) {
            const tbody = document.getElementById('inventory-table-body');
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No items found</td></tr>';
                return;
            }
            
            tbody.innerHTML = items.map(item => `
                <tr>
                    <td>${item.part_number}</td>
                    <td class="editable" data-field="vendor" data-id="${item.id}">${item.vendor}</td>
                    <td class="editable" data-field="product" data-id="${item.id}">${item.product}</td>
                    <td class="editable" data-field="description" data-id="${item.id}">${item.description || ''}</td>
                    <td class="editable" data-field="category" data-id="${item.id}">${item.category}</td>
                    <td class="editable" data-field="location" data-id="${item.id}">${item.location || ''}</td>
                    <td class="editable" data-field="min_quantity" data-id="${item.id}">${item.min_quantity}</td>
                    <td>
                        <span class="editable ${item.quantity <= item.min_quantity ? 'low-stock' : 'stock-ok'}" 
                              data-field="quantity" data-id="${item.id}">${item.quantity}</span>
                        <div style="margin-top: 5px;">
                            <button class="btn btn-sm btn-success" onclick="adjustInventory('${item.part_number}', 'add')">+</button>
                            <button class="btn btn-sm btn-danger" onclick="adjustInventory('${item.part_number}', 'remove')">-</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Initialize inline editing
            initializeInlineEditing();
        }

        function initializeInlineEditing() {
            document.querySelectorAll('.editable').forEach(cell => {
                cell.addEventListener('click', function() {
                    if (this.classList.contains('editing')) return;
                    
                    const currentValue = this.textContent.trim();
                    const field = this.dataset.field;
                    const id = this.dataset.id;
                    
                    this.classList.add('editing');
                    this.innerHTML = `<input type="${field === 'quantity' || field === 'min_quantity' ? 'number' : 'text'}" 
                                            value="${currentValue}" 
                                            onblur="saveInlineEdit(this, '${field}', '${id}')"
                                            onkeypress="if(event.key==='Enter') this.blur()"
                                            style="width: 100%;">`;
                    this.querySelector('input').focus();
                });
            });
        }

        async function saveInlineEdit(input, field, id) {
            const cell = input.parentElement;
            const newValue = input.value.trim();
            const oldValue = cell.textContent.trim();
            
            if (newValue === oldValue) {
                cell.classList.remove('editing');
                cell.textContent = oldValue;
                return;
            }
            
            try {
                const updateData = {};
                updateData[field] = field === 'quantity' || field === 'min_quantity' ? parseInt(newValue) : newValue;
                
                const response = await fetch(`/api/inventory/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) throw new Error('Failed to update inventory');
                
                cell.classList.remove('editing');
                cell.textContent = newValue;
                showAlert('success', 'Inventory updated successfully');
                
            } catch (error) {
                console.error('‚ùå Save inline edit error:', error);
                cell.classList.remove('editing');
                cell.textContent = oldValue;
                showAlert('error', 'Error updating inventory: ' + error.message);
            }
        }

        async function adjustInventory(partNumber, action) {
            const quantity = prompt(`How much to ${action}?`);
            if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) return;
            
            try {
                const response = await fetch(`/api/inventory/${partNumber}/adjust`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        action: action,
                        quantity_change: parseInt(quantity),
                        notes: `Manual ${action} via inventory page`
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to adjust inventory');
                }
                
                showAlert('success', 'Inventory adjusted successfully');
                searchInventoryPage(); // Reload table
                
            } catch (error) {
                console.error('‚ùå Adjust inventory error:', error);
                showAlert('error', 'Error adjusting inventory: ' + error.message);
            }
        }

        function addNewInventoryItem() {
            // Implementation for adding new inventory items
            showAlert('info', 'Add new inventory item functionality to be implemented');
        }

        // USER MANAGEMENT FUNCTIONS
        async function loadUsersPage() {
            console.log('üë• Loading users page...');
            
            try {
                const response = await fetch('/api/users', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load users');
                
                allUsers = await response.json();
                displayUsersTable();
                
            } catch (error) {
                console.error('‚ùå Load users error:', error);
                showAlert('error', 'Error loading users: ' + error.message);
            }
        }

        function displayUsersTable() {
            const container = document.getElementById('users-table-container');
            
            if (allUsers.length === 0) {
                container.innerHTML = '<div class="loading">No users found.</div>';
                return;
            }
            
            const canManageUsers = ['admin', 'manager'].includes(currentUser.role);
            
            container.innerHTML = `
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allUsers.map(user => `
                            <tr>
                                <td>${user.name}</td>
                                <td>${user.email}</td>
                                <td><span class="role-badge role-${user.role}">${user.role.toUpperCase()}</span></td>
                                <td><span class="status-badge ${user.active ? 'status-active' : 'status-inactive'}">${user.active ? 'Active' : 'Inactive'}</span></td>
                                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                <td>
                                    <div class="user-actions">
                                        ${(canManageUsers || currentUser.id === user.id) ? `<button class="btn btn-sm btn-primary" onclick="editUser(${user.id})">Edit</button>` : ''}
                                        <button class="btn btn-sm btn-secondary" onclick="changeUserPassword(${user.id})">Password</button>
                                        ${(canManageUsers && currentUser.id !== user.id) ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showAddUserModal() {
            if (!['admin', 'manager'].includes(currentUser.role)) {
                showAlert('error', 'Access denied');
                return;
            }
            
            editingUserId = null;
            showUserModal('Add New User', {
                name: '',
                email: '',
                role: 'technician',
                active: true
            });
        }

        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            // Check permissions
            const canManageUsers = ['admin', 'manager'].includes(currentUser.role);
            if (!canManageUsers && currentUser.id !== userId) {
                showAlert('error', 'Access denied');
                return;
            }
            
            editingUserId = userId;
            showUserModal('Edit User', user);
        }

        function showUserModal(title, user) {
            const canManageUsers = ['admin', 'manager'].includes(currentUser.role);
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="modal-close" onclick="closeUserModal()">&times;</button>
                    </div>
                    <form id="user-form" class="modal-form">
                        <div class="form-field">
                            <label for="user-name">Full Name *</label>
                            <input type="text" id="user-name" value="${user.name}" required>
                        </div>
                        
                        <div class="form-field">
                            <label for="user-email">Email Address *</label>
                            <input type="email" id="user-email" value="${user.email}" required>
                        </div>
                        
                        ${!editingUserId ? `
                            <div class="form-field">
                                <label for="user-password">Password *</label>
                                <input type="password" id="user-password" required>
                            </div>
                        ` : ''}
                        
                        ${canManageUsers ? `
                            <div class="form-field">
                                <label for="user-role">Role</label>
                                <select id="user-role">
                                    <option value="technician" ${user.role === 'technician' ? 'selected' : ''}>Technician</option>
                                    <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrator</option>
                                </select>
                            </div>
                            
                            ${editingUserId ? `
                                <div class="form-field">
                                    <label>
                                        <input type="checkbox" id="user-active" ${user.active ? 'checked' : ''}> 
                                        Active User
                                    </label>
                                </div>
                            ` : ''}
                        ` : ''}
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">${editingUserId ? 'Update' : 'Create'} User</button>
                        </div>
                    </form>
                </div>
            `;
            
            // CRITICAL: Append to body, not to any content area
            document.body.appendChild(modal);
            document.body.classList.add('modal-open');
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeUserModal();
                }
            });
            
            // Prevent content scrolling
            modal.querySelector('.modal-content').addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Add form submit handler
            document.getElementById('user-form').addEventListener('submit', handleUserSubmit);
            
            // Focus first input after a brief delay
            setTimeout(() => {
                const firstInput = document.getElementById('user-name');
                if (firstInput) {
                    firstInput.focus();
                    firstInput.select();
                }
            }, 100);
        }

        async function handleUserSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const password = document.getElementById('user-password')?.value;
            const role = document.getElementById('user-role')?.value || 'technician';
            const active = document.getElementById('user-active')?.checked ?? true;
            
            if (!name || !email) {
                showAlert('error', 'Name and email are required');
                return;
            }
            
            if (!editingUserId && !password) {
                showAlert('error', 'Password is required for new users');
                return;
            }
            
            try {
                const userData = { name, email, role, active };
                if (!editingUserId) userData.password = password;
                
                const url = editingUserId ? `/api/users/${editingUserId}` : '/api/users';
                const method = editingUserId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(userData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save user');
                }
                
                showAlert('success', `User ${editingUserId ? 'updated' : 'created'} successfully`);
                closeUserModal();
                loadUsersPage(); // Reload users table
                
            } catch (error) {
                console.error('‚ùå Save user error:', error);
                showAlert('error', 'Error saving user: ' + error.message);
            }
        }

        function closeUserModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
            document.body.classList.remove('modal-open');
            editingUserId = null;
        }

        function changeUserPassword(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            // Check permissions
            const canManageUsers = ['admin', 'manager'].includes(currentUser.role);
            if (!canManageUsers && currentUser.id !== userId) {
                showAlert('error', 'Access denied');
                return;
            }
            
            showPasswordModal(userId, user.name);
        }

        function showPasswordModal(userId, userName) {
            const isOwnPassword = currentUser.id === userId;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Change Password - ${userName}</h3>
                        <button class="modal-close" onclick="closePasswordModal()">&times;</button>
                    </div>
                    <form id="password-form" class="modal-form">
                        ${isOwnPassword ? `
                            <div class="form-field">
                                <label for="current-password">Current Password *</label>
                                <input type="password" id="current-password" required>
                            </div>
                        ` : ''}
                        
                        <div class="form-field">
                            <label for="new-password">New Password *</label>
                            <input type="password" id="new-password" required minlength="6">
                        </div>
                        
                        <div class="form-field">
                            <label for="confirm-password">Confirm New Password *</label>
                            <input type="password" id="confirm-password" required minlength="6">
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Change Password</button>
                        </div>
                    </form>
                </div>
            `;
            
            // CRITICAL: Append to body, not to any content area
            document.body.appendChild(modal);
            document.body.classList.add('modal-open');
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePasswordModal();
                }
            });
            
            // Prevent content scrolling
            modal.querySelector('.modal-content').addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Add form submit handler
            document.getElementById('password-form').addEventListener('submit', (e) => handlePasswordSubmit(e, userId));
            
            // Focus first input after a brief delay
            setTimeout(() => {
                const firstInput = isOwnPassword ? 
                    document.getElementById('current-password') : 
                    document.getElementById('new-password');
                if (firstInput) {
                    firstInput.focus();
                }
            }, 100);
        }

        async function handlePasswordSubmit(e, userId) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password')?.value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                showAlert('error', 'New passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                showAlert('error', 'Password must be at least 6 characters');
                return;
            }
            
            try {
                const requestData = { newPassword };
                if (currentPassword) requestData.currentPassword = currentPassword;
                
                const response = await fetch(`/api/users/${userId}/password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to change password');
                }
                
                showAlert('success', 'Password changed successfully');
                closePasswordModal();
                
            } catch (error) {
                console.error('‚ùå Change password error:', error);
                showAlert('error', 'Error changing password: ' + error.message);
            }
        }

        function closePasswordModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
            document.body.classList.remove('modal-open');
        }

        async function deleteUser(userId) {
            if (!['admin', 'manager'].includes(currentUser.role)) {
                showAlert('error', 'Access denied');
                return;
            }
            
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            if (currentUser.id === userId) {
                showAlert('error', 'Cannot delete your own account');
                return;
            }
            
            if (!confirm(`Are you sure you want to deactivate user "${user.name}"?\n\nThis will disable their access to the system.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to delete user');
                }
                
                showAlert('success', 'User deactivated successfully');
                loadUsersPage(); // Reload users table
                
            } catch (error) {
                console.error('‚ùå Delete user error:', error);
                showAlert('error', 'Error deleting user: ' + error.message);
            }
        }

        // Additional page functions
        async function loadRecentNotesPage() {
            console.log('üìã Loading recent notes page...');
            
            try {
                // Load employees for filter
                const response = await fetch('/api/users', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    const employeeSelect = document.getElementById('notes-employee');
                    
                    if (employeeSelect) {
                        employeeSelect.innerHTML = '<option value="">All Employees</option>' + 
                            users.map(user => `<option value="${user.id}">${user.name}</option>`).join('');
                    }
                }
                
                // Load recent notes
                loadRecentNotes();
                
            } catch (error) {
                console.error('‚ùå Load recent notes page error:', error);
            }
        }

        async function loadRecentNotes() {
            const days = document.getElementById('notes-days').value;
            const employee = document.getElementById('notes-employee').value;
            
            try {
                let url = `/api/notes/recent?days=${days}`;
                if (employee) url += `&employee=${employee}`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load recent notes');
                
                const notes = await response.json();
                displayNotesResults(notes, 'recent-notes-results');
                
            } catch (error) {
                console.error('‚ùå Load recent notes error:', error);
                showAlert('error', 'Error loading recent notes: ' + error.message);
            }
        }

        async function loadSearchNotesPage() {
            console.log('üîç Loading search notes page...');
            
            try {
                // Load employees for filter
                const response = await fetch('/api/users', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    const searchEmployeeSelect = document.getElementById('search-employee');
                    
                    if (searchEmployeeSelect) {
                        searchEmployeeSelect.innerHTML = '<option value="">All Employees</option>' + 
                            users.map(user => `<option value="${user.id}">${user.name}</option>`).join('');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Load search notes page error:', error);
            }
        }

        async function searchNotes() {
            const query = document.getElementById('search-query').value;
            const employee = document.getElementById('search-employee').value;
            const startDate = document.getElementById('search-start-date').value;
            const endDate = document.getElementById('search-end-date').value;
            
            try {
                let url = '/api/search/notes?';
                const params = [];
                
                if (query) params.push(`q=${encodeURIComponent(query)}`);
                if (employee) params.push(`employee=${employee}`);
                if (startDate) params.push(`start_date=${startDate}`);
                if (endDate) params.push(`end_date=${endDate}`);
                
                url += params.join('&');
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to search notes');
                
                const notes = await response.json();
                displayNotesResults(notes, 'search-results');
                
            } catch (error) {
                console.error('‚ùå Search notes error:', error);
                showAlert('error', 'Error searching notes: ' + error.message);
            }
        }

        function displayNotesResults(notes, containerId) {
            const container = document.getElementById(containerId);
            
            if (notes.length === 0) {
                container.innerHTML = '<div class="loading">No notes found matching your criteria.</div>';
                return;
            }
            
            container.innerHTML = notes.map(note => `
                <div class="shift-note-result" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="shift-note-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #2d3748;">${note.title}</h4>
                        <div style="font-size: 12px; color: #718096;">
                            ${note.created_by_name} ‚Ä¢ ${new Date(note.shift_date).toLocaleDateString()}
                        </div>
                    </div>
                    ${note.content ? `
                        <div class="shift-note-content" style="color: #4a5568; margin-bottom: 10px;">${note.content}</div>
                    ` : ''}
                    
                    ${note.task_titles ? `
                        <div class="shift-note-summary" style="font-size: 14px; color: #718096;">
                            <strong>Tasks:</strong> ${note.task_titles}
                        </div>
                    ` : ''}
                    
                    <div class="shift-note-stats" style="display: flex; gap: 15px; margin-top: 10px;">
                        <div class="shift-note-stat" style="display: flex; align-items: center; gap: 5px; font-size: 12px; color: #718096;">
                            <span class="icon">üìù</span>
                            <span>Tasks: ${note.task_count || 0}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadReportsPage() {
            console.log('üìà Loading reports page...');
        }

        function generateInventoryReport(type) {
            showAlert('info', `${type} report functionality to be implemented`);
        }

        function generateShiftSummary() {
            if (!currentShift) {
                showAlert('error', 'No active shift found');
                return;
            }
            showAlert('info', 'Shift summary generation to be implemented');
        }

        // Utility Functions
        function showLoading(message = 'Loading...') {
            const existingLoader = document.getElementById('loading-indicator');
            if (existingLoader) {
                existingLoader.remove();
            }
            
            const loader = document.createElement('div');
            loader.id = 'loading-indicator';
            loader.className = 'loading';
            loader.textContent = message;
            loader.style.cssText = 'position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000;';
            
            document.body.appendChild(loader);
        }

        function hideLoading() {
            const loader = document.getElementById('loading-indicator');
            if (loader) {
                loader.remove();
            }
        }

        function showAlert(type, message) {
            console.log(`üì¢ Alert (${type}):`, message);
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const pageContent = document.getElementById('page-content');
            if (pageContent) {
                pageContent.insertBefore(alertDiv, pageContent.firstChild);
                
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
        }

        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 5000);
            }
        }
    </script>
</body>
</html>